
"""
P√°ginas de la aplicaci√≥n Streamlit
"""
import os

# Importaciones seguras
try:
    import streamlit as st
    STREAMLIT_AVAILABLE = True
except ImportError:
    STREAMLIT_AVAILABLE = False

try:
    import pandas as pd
    PANDAS_AVAILABLE = True
except ImportError:
    PANDAS_AVAILABLE = False

from typing import List, Optional
from datetime import datetime, timedelta

# Importar modelos y servicios de manera segura
try:
    from ..models.data_models import Store, LocationInfo
    MODELS_AVAILABLE = True
except ImportError:
    MODELS_AVAILABLE = False
    # Definir clases b√°sicas como fallback
    class Store:
        def __init__(self, **kwargs):
            for k, v in kwargs.items():
                setattr(self, k, v)
    
    class LocationInfo:
        def __init__(self, **kwargs):
            for k, v in kwargs.items():
                setattr(self, k, v)

try:
    from ..services.location_service import location_service
    LOCATION_SERVICE_AVAILABLE = True
except ImportError:
    LOCATION_SERVICE_AVAILABLE = False
from ..services.database_service import db_service
from ..services.weather_service import weather_service
from ..core.suggestion_engine import suggestion_engine
from ..ui.components import ui_components
from ..config.settings import PARAGUAY_HOLIDAYS


class Pages:
    """P√°ginas de la aplicaci√≥n"""
    
    @staticmethod
    def configure_store_page():
        """P√°gina para configurar una nueva tienda"""
        st.header("üè™ Configurar Nueva Tienda")
        
        st.markdown("""
        ### ¬°Bienvenido! Configuremos tu helader√≠a Grido
        
        Para generar sugerencias precisas, necesitamos algunos datos b√°sicos de tu tienda.
        Puedes detectar autom√°ticamente tu ubicaci√≥n o ingresarla manualmente.
        """)
        
        # Secci√≥n de detecci√≥n autom√°tica
        st.subheader("üéØ Detecci√≥n Autom√°tica de Ubicaci√≥n")
        
        col1, col2 = st.columns([1, 1])
        
        with col1:
            if st.button("üåç Detectar Mi Ubicaci√≥n", type="primary"):
                with st.spinner("Detectando ubicaci√≥n..."):
                    try:
                        location_info = location_service.detect_location_by_ip()
                        if location_info:
                            st.session_state.detected_location = location_info
                            ui_components.render_success_message(
                                f"üìç Ubicaci√≥n detectada: {location_info.city}, {location_info.country}",
                                balloons=True
                            )
                        else:
                            ui_components.render_error_message("No se pudo detectar la ubicaci√≥n autom√°ticamente")
                    except Exception as e:
                        ui_components.render_error_message(f"Error detectando ubicaci√≥n: {e}")
        
        with col2:
            if 'detected_location' in st.session_state:
                info = st.session_state.detected_location
                st.success("‚úÖ **Detectado:**")
                st.write(f"üìç **Ciudad:** {info.city}")
                st.write(f"üè≥Ô∏è **Pa√≠s:** {info.country}")
                st.write(f"üìä **Coordenadas:** {info.lat:.4f}, {info.lon:.4f}")
        
        st.divider()
        
        # Secci√≥n de b√∫squeda de tiendas con Google Maps
        st.subheader("üîç Buscar Tienda Grido")
        st.markdown("""
        **üí° Busca tu tienda en Google Maps** y haz clic en ella para ver sus coordenadas.
        Luego copia la informaci√≥n en el formulario de abajo.
        """)
        
        # Gu√≠a de uso del buscador de Google Maps
        with st.expander("üìñ C√≥mo usar el buscador de Google Maps"):
            st.markdown("""
            **üéØ Pasos para encontrar tu tienda:**
            
            1. üîç **Busca en el mapa de abajo:** Escribe "Grido" + tu ubicaci√≥n
               - Ejemplos: *"Grido Asunci√≥n"*, *"Grido Villa Morra"*, *"Grido Shopping del Sol"*
            
            2. üìç **Haz clic en el marcador** de tu tienda en el mapa
            
            3. üëÜ **Haz clic derecho** en la ubicaci√≥n exacta del marcador
            
            4. üìã **Copia las coordenadas** que aparecen (Ej: -25.2637, -57.5759)
            
            5. üìù **P√©galas en el formulario de abajo** en los campos de Latitud y Longitud
            
            **üí° Tip:** Tambi√©n puedes usar el bot√≥n "üìç Usar esta ubicaci√≥n" que aparecer√° abajo del mapa
            """)
        
        # Obtener Google API Key
        google_api_key = os.getenv('GOOGLE_PLACES_API_KEY', '')
        
        if google_api_key and google_api_key != 'demo':
            # Buscador interactivo de Google Maps
            st.markdown("### üó∫Ô∏è Buscador de Google Maps")
            
            # Input para b√∫squeda inicial
            search_query = st.text_input(
                "üîç Buscar tu tienda Grido",
                placeholder="Ej: 'Grido Asunci√≥n', 'Grido Villa Morra', 'Grido Shopping del Sol'",
                help="Busca tu tienda y haz clic en el marcador para ver las coordenadas"
            )
            
            # Preparar la query para Google Maps
            if search_query:
                search_encoded = search_query.replace(' ', '+')
            else:
                search_encoded = "Grido+Paraguay"
            
            # Iframe de Google Maps con b√∫squeda
            st.markdown(
                f'<iframe width="100%" height="500" frameborder="0" style="border:0" '
                f'src="https://www.google.com/maps/search/{search_encoded}/@-25.2637,-57.5759,12z" '
                f'allowfullscreen></iframe>',
                unsafe_allow_html=True
            )
            
            st.info("üí° **Instrucciones:** Busca tu tienda en el mapa ‚Üë, haz clic en ella, luego clic derecho para copiar las coordenadas y p√©galas en el formulario ‚Üì")
            
            # Bot√≥n para capturar coordenadas manualmente
            col1, col2 = st.columns(2)
            with col1:
                manual_lat = st.number_input("Latitud copiada", value=-25.2637, format="%.6f", help="Pega aqu√≠ la latitud del mapa")
            with col2:
                manual_lon = st.number_input("Longitud copiada", value=-57.5759, format="%.6f", help="Pega aqu√≠ la longitud del mapa")
            
            if st.button("üìç Usar esta ubicaci√≥n del mapa", type="primary"):
                st.session_state.map_selected_location = {
                    'lat': manual_lat,
                    'lon': manual_lon,
                    'from_map': True
                }
                st.success(f"‚úÖ Ubicaci√≥n capturada: {manual_lat:.4f}, {manual_lon:.4f}")
                st.rerun()
        else:
            st.warning("‚ö†Ô∏è Para usar el buscador de Google Maps, configura `GOOGLE_PLACES_API_KEY` en tu archivo `.env`")
            
            # Sistema de b√∫squeda alternativo
            col1, col2 = st.columns([2, 1])
            
            with col1:
                search_query = st.text_input(
                    "üîç Buscar tienda (Base de datos local)",
                    placeholder="Ej: 'Grido Seminario', 'Grido Villa Morra', 'Grido Shopping'",
                    help="B√∫squeda en base de datos local de tiendas Grido"
                )
            
            with col2:
                search_type = st.selectbox(
                    "Tipo de b√∫squeda",
                    ["üè™ Solo tiendas Grido", "üìç Direcci√≥n general"],
                    help="Selecciona el tipo de b√∫squeda",
                    index=0
                )
        
        # Solo mostrar b√∫squeda local si no hay Google Maps API
        if not google_api_key or google_api_key == 'demo':
            if search_query and len(search_query) >= 3:
                with st.spinner("üîç Buscando tiendas..."):
                    try:
                        if search_type == "üè™ Solo tiendas Grido":
                            # Usar b√∫squeda inteligente con contexto geogr√°fico
                            if LOCATION_SERVICE_AVAILABLE:
                                grido_results = location_service.search_grido_with_context(search_query)
                            
                            if grido_results:
                                st.success(f"üéâ Encontradas {len(grido_results)} tiendas Grido:")
                                
                                # Mostrar estad√≠sticas de b√∫squeda
                                exact_matches = len([r for r in grido_results if r.get('match_type') == 'exact'])
                                fuzzy_matches = len([r for r in grido_results if r.get('match_type') == 'fuzzy'])
                                
                                if exact_matches > 0 and fuzzy_matches > 0:
                                    st.info(f"üìä {exact_matches} coincidencias exactas, {fuzzy_matches} similares")
                                elif fuzzy_matches > 0:
                                    st.info(f"üîç B√∫squeda inteligente encontr√≥ {fuzzy_matches} tiendas similares")
                                
                                for i, store in enumerate(grido_results):
                                    with st.container():
                                        col1, col2, col3 = st.columns([3, 2, 1])
                                        
                                        with col1:
                                            # Mostrar indicador de calidad de coincidencia
                                            score = store.get('score', 0)
                                            match_type = store.get('match_type', 'unknown')
                                            source = store.get('source', 'unknown')
                                            
                                            # Iconos seg√∫n tipo de coincidencia
                                            if match_type == 'geographic':
                                                quality_icon = "üó∫Ô∏è"
                                                match_desc = "Coincidencia geogr√°fica"
                                            elif score >= 0.9:
                                                quality_icon = "üéØ"
                                                match_desc = "Coincidencia exacta"
                                            elif score >= 0.7:
                                                quality_icon = "üé™"
                                                match_desc = "Coincidencia alta"
                                            else:
                                                quality_icon = "üîç"
                                                match_desc = "Coincidencia parcial"
                                            
                                            st.markdown(f"**{quality_icon} {store['name']}**")
                                            st.markdown(f"üìç {store['address']}")
                                            st.markdown(f"üèôÔ∏è {store['city'].replace('_', ' ').title()}")
                                            
                                            # Mostrar t√©rminos de coincidencia geogr√°fica si est√°n disponibles
                                            if store.get('matched_terms'):
                                                matched_terms = ', '.join(store['matched_terms'])
                                                st.markdown(f"üéØ **Coincidencias:** {matched_terms}")
                                            
                                            # Mostrar tel√©fono si est√° disponible
                                            if store.get('phone'):
                                                st.markdown(f"üìû {store['phone']}")
                                        
                                        with col2:
                                            st.markdown(f"**üìä Informaci√≥n:**")
                                            st.markdown(f"Lat: {store['lat']:.4f}")
                                            st.markdown(f"Lon: {store['lon']:.4f}")
                                            
                                            # Mostrar puntaje de relevancia
                                            score_percent = int(score * 100)
                                            st.markdown(f"üéØ Relevancia: {score_percent}%")
                                            
                                            # Mostrar tipo de b√∫squeda usado
                                            source_icons = {
                                                'local_geographic': 'üó∫Ô∏è',
                                                'local_traditional': 'üíæ',
                                                'google_maps': 'üîç',
                                                'openstreetmap': 'üåê',
                                                'online_geographic': 'üåê'
                                            }
                                            source_icon = source_icons.get(source, '‚ùì')
                                            st.markdown(f"{source_icon} {match_desc}")
                                            
                                            # Informaci√≥n adicional para resultados de Google Maps
                                            if source == 'google_maps':
                                                rating = store.get('rating', 0)
                                                if rating > 0:
                                                    stars = '‚≠ê' * int(rating)
                                                    st.markdown(f"‚≠ê **{rating}/5** {stars}")
                                                
                                                total_reviews = store.get('user_ratings_total', 0)
                                                if total_reviews > 0:
                                                    st.markdown(f"üë• {total_reviews} rese√±as")
                                        
                                        with col3:
                                            if st.button(f"‚úÖ Usar", key=f"grido_{i}"):
                                                st.session_state.selected_store = {
                                                    'name': store['name'],
                                                    'lat': store['lat'],
                                                    'lon': store['lon'],
                                                    'city': store['city'].replace('_', ' ').title(),
                                                    'country': 'Paraguay',
                                                    'address': store['address']
                                                }
                                                st.success(f"üéâ Tienda '{store['name']}' seleccionada!")
                                                st.rerun()
                                        
                                        st.divider()
                            else:
                                # Sugerencias de b√∫squeda si no se encuentra nada
                                st.warning("üîç No se encontraron tiendas Grido con ese t√©rmino.")
                                st.markdown("""
                                **üí° Sugerencias de b√∫squeda:**
                                - Prueba con nombres de ciudades: *Asunci√≥n*, *Ciudad del Este*, *Encarnaci√≥n*
                                - Usa nombres de barrios: *Centro*, *Villa Morra*, *Las Mercedes*
                                - T√©rminos generales: *Shopping*, *Aeropuerto*, *Terminal*
                                - Tambi√©n puedes usar sin√≥nimos: *CDE* por Ciudad del Este, *Asu* por Asunci√≥n
                                """)
                        else:
                            st.error("‚ùå Servicio de b√∫squeda no disponible")
                    
                    elif search_type == "üìç Direcci√≥n general":
                        # Buscar usando el servicio de ubicaci√≥n
                        if LOCATION_SERVICE_AVAILABLE:
                                search_results = location_service.search_address(search_query)
                                
                                if search_results:
                                    st.success(f"üéâ Encontradas {len(search_results)} ubicaciones:")
                                    
                                    for i, result in enumerate(search_results[:3]):  # Limitar a 3 resultados
                                        with st.container():
                                            col1, col2, col3 = st.columns([3, 2, 1])
                                            
                                            with col1:
                                                st.markdown(f"**üìç {result.get('address', 'Direcci√≥n')}**")
                                                st.markdown(f"üèôÔ∏è {result.get('city', '')}, {result.get('country', '')}")
                                            
                                            with col2:
                                                st.markdown(f"**üìä Coordenadas:**")
                                                st.markdown(f"Lat: {result['lat']:.4f}")
                                                st.markdown(f"Lon: {result['lon']:.4f}")
                                            
                                            with col3:
                                                if st.button(f"‚úÖ Usar", key=f"address_{i}"):
                                                    st.session_state.selected_store = {
                                                        'name': search_query,
                                                        'lat': result['lat'],
                                                        'lon': result['lon'],
                                                        'city': result.get('city', ''),
                                                        'country': result.get('country', ''),
                                                        'address': result.get('address', '')
                                                    }
                                                    st.success(f"üéâ Ubicaci√≥n seleccionada!")
                                                    st.rerun()
                                            
                                            st.divider()
                                else:
                                    st.warning("üîç No se encontraron resultados. Verifica la direcci√≥n o usa coordenadas manuales.")
                            else:
                                st.warning("‚ö†Ô∏è Servicio de b√∫squeda no disponible. Usa coordenadas manuales.")
                    
                    except Exception as e:
                        st.error(f"‚ùå Error en la b√∫squeda: {e}")
                        import logging
                        logger = logging.getLogger(__name__)
                        logger.error(f"Error en b√∫squeda: {e}")
        
        # Mostrar tienda seleccionada CON MAPA DE CONFIRMACI√ìN
        if 'selected_store' in st.session_state:
            store = st.session_state.selected_store
            st.success("üéØ **Tienda seleccionada:**")
            
            col1, col2 = st.columns(2)
            with col1:
                st.write(f"üè™ **Nombre:** {store['name']}")
                st.write(f"üìç **Direcci√≥n:** {store.get('address', 'N/A')}")
                st.write(f"üèôÔ∏è **Ciudad:** {store['city']}")
            with col2:
                st.write(f"üè≥Ô∏è **Pa√≠s:** {store['country']}")
                st.write(f"üìä **Coordenadas:** {store['lat']:.4f}, {store['lon']:.4f}")
            
            # MAPA DE VISTA PREVIA PARA CONFIRMAR UBICACI√ìN
            st.markdown("### üó∫Ô∏è Confirma que esta es tu tienda:")
            
            # Obtener Google API Key
            google_api_key = os.getenv('GOOGLE_PLACES_API_KEY', '')
            
            if google_api_key and google_api_key != 'demo':
                # Google Maps con marcador y nombre de tienda
                store_lat = store['lat']
                store_lon = store['lon']
                store_name = store['name'].replace(' ', '+')
                store_address = store.get('address', '').replace(' ', '+')
                
                # URL de Google Maps para abrir (con b√∫squeda por nombre + direcci√≥n para mejor precisi√≥n)
                google_maps_link = f"https://www.google.com/maps/search/?api=1&query={store_name}+{store_address}"
                
                # Usar API de Google Maps Embed con el nombre de la tienda para encontrar el lugar exacto
                # Esto es m√°s preciso que solo coordenadas porque Google identifica el negocio
                embed_query = f"{store_name},+{store_address}".replace(' ', '+')
                
                # Iframe con Google Maps usando Place mode para encontrar el negocio exacto
                st.markdown(
                    f'<iframe width="100%" height="450" frameborder="0" style="border:0;border-radius:8px;" '
                    f'src="https://www.google.com/maps?q={embed_query}&output=embed&z=18" '
                    f'allowfullscreen loading="lazy"></iframe>',
                    unsafe_allow_html=True
                )
                
                st.markdown(f"[üìç Abrir en Google Maps App]({google_maps_link})")
                st.caption(f"üìç Coordenadas exactas: {store_lat:.6f}, {store_lon:.6f}")
            else:
                # Fallback a mapa de Streamlit
                map_df = pd.DataFrame([[store['lat'], store['lon']]], columns=['lat', 'lon'])
                st.map(map_df, zoom=17)
            
            # Botones de acci√≥n
            col1, col2 = st.columns(2)
            with col1:
                if st.button("‚úÖ Confirmar y Continuar", type="primary", use_container_width=True):
                    st.success("‚úÖ ¬°Ubicaci√≥n confirmada! Completa el formulario abajo.")
            with col2:
                if st.button("üóëÔ∏è Buscar otra tienda", use_container_width=True):
                    del st.session_state.selected_store
                    st.rerun()
        
        st.divider()
        
        # Formulario de configuraci√≥n
        st.subheader("üìù Informaci√≥n de la Tienda")
        
        # Prioridad: tienda seleccionada > ubicaci√≥n del mapa > ubicaci√≥n detectada > valores por defecto
        if 'selected_store' in st.session_state:
            default_values = st.session_state.selected_store
            st.info("üìã Usando datos de la tienda seleccionada. Puedes modificarlos si es necesario.")
        elif 'map_selected_location' in st.session_state:
            map_loc = st.session_state.map_selected_location
            default_values = {
                'lat': map_loc['lat'],
                'lon': map_loc['lon'],
                'name': '',
                'city': '',
                'country': 'Paraguay'
            }
            st.success("‚úÖ Usando coordenadas del mapa de Google Maps. Completa el nombre y ciudad de tu tienda.")
        elif 'detected_location' in st.session_state:
            default_values = st.session_state.detected_location
            st.info("üìã Usando ubicaci√≥n detectada autom√°ticamente. Puedes modificarla si es necesario.")
        else:
            default_values = LocationInfo(-25.2637, -57.5759, "Asunci√≥n", "Paraguay")
        
        name = st.text_input(
            "üè™ Nombre de la tienda", 
            value=getattr(default_values, 'name', ''),
            placeholder="Ej: Grido Asunci√≥n Centro"
        )
        
        col1, col2 = st.columns(2)
        with col1:
            city = st.text_input(
                "üèôÔ∏è Ciudad", 
                value=getattr(default_values, 'city', ''), 
                placeholder="Ej: Asunci√≥n"
            )
            country = st.text_input(
                "üè≥Ô∏è Pa√≠s", 
                value=getattr(default_values, 'country', 'Paraguay'), 
                placeholder="Ej: Paraguay"
            )
        
        with col2:
            lat = st.number_input(
                "üìä Latitud", 
                value=float(getattr(default_values, 'lat', -25.2637)), 
                format="%.6f", 
                help="Coordenada geogr√°fica Norte-Sur"
            )
            lon = st.number_input(
                "üìä Longitud", 
                value=float(getattr(default_values, 'lon', -57.5759)), 
                format="%.6f",
                help="Coordenada geogr√°fica Este-Oeste"
            )
        
        # Mostrar mapa de confirmaci√≥n final
        if lat and lon and 'selected_store' not in st.session_state:
            st.subheader("üìç Vista Previa de Ubicaci√≥n")
            st.info("üí° Verifica que las coordenadas correspondan a tu tienda")
            
            # Obtener Google API Key
            google_api_key = os.getenv('GOOGLE_PLACES_API_KEY', '')
            
            if google_api_key and google_api_key != 'demo':
                # Google Maps con zoom m√°s cercano para ver detalles
                google_maps_link = f"https://www.google.com/maps/search/?api=1&query={lat},{lon}"
                
                st.markdown(
                    f'<iframe width="100%" height="450" frameborder="0" style="border:0" '
                    f'src="https://maps.google.com/maps?q={lat},{lon}&z=17&output=embed" '
                    f'allowfullscreen></iframe>',
                    unsafe_allow_html=True
                )
                
                st.markdown(f"[üó∫Ô∏è Abrir en Google Maps]({google_maps_link})")
            else:
                # Fallback a mapa de Streamlit
                map_df = pd.DataFrame([[lat, lon]], columns=['lat', 'lon'])
                st.map(map_df, zoom=15)
                st.caption("üí° Configura GOOGLE_PLACES_API_KEY para ver el mapa de Google Maps")
        
        st.divider()
        
        # Configuraci√≥n de demanda base
        st.subheader("‚öôÔ∏è Configuraci√≥n de Demanda Base")
        
        st.markdown("""
        Estos son los valores promedio de venta por d√≠a en condiciones normales (temperatura 20-25¬∞C).
        La IA los ajustar√° autom√°ticamente seg√∫n el clima y eventos especiales.
        """)
        
        # Interfaz m√°s amigable para configurar demanda
        col1, col2, col3 = st.columns(3)
        
        with col1:
            st.markdown("**üç≠ Productos por Unidades**")
            palitos_per_day = st.number_input("Palitos/d√≠a", value=3.4, min_value=0.1, step=0.1, 
                                            help="Unidades de palitos vendidas por d√≠a")
            conos_per_day = st.number_input("Conos/d√≠a", value=3.0, min_value=0.1, step=0.1,
                                          help="Unidades de conos vendidas por d√≠a")
            vasitos_per_day = st.number_input("Vasitos/d√≠a", value=2.0, min_value=0.1, step=0.1,
                                            help="Unidades de vasitos vendidas por d√≠a")
        
        with col2:
            st.markdown("**ü•Ñ Helados por Kilos**")
            potes_kg_per_day = st.number_input("Potes (kg)/d√≠a", value=1.1, min_value=0.1, step=0.1,
                                             help="Kilos de helado en potes vendidos por d√≠a")
            helado_premium_kg_per_day = st.number_input("Premium (kg)/d√≠a", value=0.6, min_value=0.1, step=0.1,
                                                       help="Kilos de helado premium vendidos por d√≠a")
        
        with col3:
            st.markdown("**üìä Resumen Semanal**")
            total_palitos_week = palitos_per_day * 7
            total_conos_week = conos_per_day * 7
            total_potes_week = potes_kg_per_day * 7
            st.metric("Palitos/semana", f"{total_palitos_week:.1f}")
            st.metric("Conos/semana", f"{total_conos_week:.1f}")
            st.metric("Potes (kg)/semana", f"{total_potes_week:.1f}")
        
        # Crear el diccionario de demanda base
        base_demand = {
            "palitos_u_per_day": palitos_per_day,
            "conos_u_per_day": conos_per_day,
            "vasitos_u_per_day": vasitos_per_day,
            "potes_kg_per_day": potes_kg_per_day,
            "helado_premium_kg_per_day": helado_premium_kg_per_day
        }
        
        st.divider()
        
        # Validaci√≥n y guardado
        if st.button("üíæ Guardar Configuraci√≥n de Tienda", type="primary", use_container_width=True):
            # Validaciones
            errors = []
            if not name.strip():
                errors.append("‚ùå El nombre de la tienda es obligatorio")
            if not city.strip():
                errors.append("‚ùå La ciudad es obligatoria")
            if not country.strip():
                errors.append("‚ùå El pa√≠s es obligatorio")
            if not (-90 <= lat <= 90):
                errors.append("‚ùå La latitud debe estar entre -90 y 90")
            if not (-180 <= lon <= 180):
                errors.append("‚ùå La longitud debe estar entre -180 y 180")
            
            if errors:
                for error in errors:
                    ui_components.render_error_message(error)
            else:
                try:
                    # Crear store y guardar
                    store = Store(
                        name=name.strip(),
                        lat=lat,
                        lon=lon,
                        city=city.strip(),
                        country=country.strip(),
                        base_demand=base_demand
                    )
                    
                    store_id = db_service.save_store(store)
                    ui_components.render_success_message(
                        "üéâ ¬°Tienda configurada exitosamente!",
                        balloons=True
                    )
                    
                    # Limpiar la ubicaci√≥n detectada
                    if 'detected_location' in st.session_state:
                        del st.session_state.detected_location
                    
                    ui_components.render_info_message(
                        "üí° Ahora puedes ir a 'Generar Sugerencia' para obtener recomendaciones inteligentes."
                    )
                    
                except Exception as e:
                    ui_components.render_error_message(f"‚ùå Error al guardar la tienda: {e}")
    
    @staticmethod
    def view_stores_page():
        """P√°gina para ver tiendas registradas"""
        st.header("üìç Tiendas Registradas")
        
        stores = db_service.get_stores()
        
        if not stores:
            ui_components.render_info_message("üè™ No hay tiendas registradas a√∫n.")
            st.markdown("""
            ### üëã ¬°Parece que es tu primera vez aqu√≠!
            
            Para comenzar a usar el sistema de sugerencias inteligente:
            
            1. üè™ Ve a **"Configurar Tienda"** para registrar tu primera helader√≠a
            2. ü§ñ Luego podr√°s generar sugerencias personalizadas
            3. üìä Y ver el historial de todas tus sugerencias
            
            ¬°Es muy f√°cil y r√°pido!
            """)
        else:
            st.markdown(f"**üìä Total de tiendas:** {len(stores)}")
            
            # Mostrar tiendas en tarjetas
            for store in stores:
                ui_components.render_store_card(store)
    
    @staticmethod
    def generate_suggestion_page():
        """P√°gina para generar sugerencias"""
        st.header("ü§ñ Generar Sugerencia Semanal")
        
        stores = db_service.list_stores()
        
        if not stores:
            ui_components.render_info_message("Registra primero una tienda.")
            return
        
        # Selector de tienda
        st.subheader("üè™ Selecciona tu Tienda")
        store_options = {store.id: f"{store.name} ({store.city})" for store in stores}
        selected_store_id = st.selectbox(
            "Tienda:",
            options=list(store_options.keys()),
            format_func=lambda x: store_options[x]
        )
        
        selected_store = next(s for s in stores if s.id == selected_store_id)
        
        # Selector de estrategia
        strategy = ui_components.render_strategy_selector()
        
        # Opciones avanzadas
        with st.expander("‚öôÔ∏è Opciones Avanzadas"):
            st.markdown("**Fuente de Datos Meteorol√≥gicos:**")
            weather_source = st.radio(
                "Fuente:",
                ["OpenWeatherMap (Recomendado)", "Infoclima (Experimental)"],
                index=0
            )
            
            show_charts = st.checkbox("üìä Mostrar gr√°ficos detallados", value=True)
        
        # Bot√≥n para generar
        if st.button("üöÄ Generar Sugerencia Inteligente", type="primary", use_container_width=True):
            with st.spinner("ü§ñ Analizando clima, demanda y generando sugerencias..."):
                try:
                    # Obtener pron√≥stico meteorol√≥gico
                    forecast = weather_service.get_weekly_forecast(selected_store.lat, selected_store.lon)
                    
                    if not forecast:
                        ui_components.render_error_message("‚ùå No se pudo obtener el pron√≥stico meteorol√≥gico")
                        return
                    
                    # Generar sugerencia
                    suggestion = suggestion_engine.generate_weekly_suggestion(
                        selected_store, forecast, strategy
                    )
                    
                    # Guardar en base de datos
                    suggestion_id = db_service.save_suggestion(suggestion)
                    
                    # Mostrar resultados
                    Pages._display_suggestion_results(suggestion, forecast, show_charts)
                    
                    ui_components.render_success_message(
                        "‚úÖ Sugerencia generada y guardada en el historial",
                        balloons=True
                    )
                    
                except Exception as e:
                    ui_components.render_error_message(f"‚ùå Error generando sugerencia: {e}")
    
    @staticmethod
    def history_analytics_page():
        """P√°gina de historial y an√°lisis"""
        st.header("üìà Historial & Analytics")
        
        # Tabs para diferentes vistas
        tab1, tab2, tab3 = st.tabs(["üìã Historial", "üìä Analytics", "üìà Tendencias"])
        
        with tab1:
            Pages._display_suggestions_history()
        
        with tab2:
            Pages._display_analytics()
        
        with tab3:
            Pages._display_trends()
    
    @staticmethod
    def _display_suggestion_results(suggestion, forecast, show_charts=True):
        """Muestra los resultados de una sugerencia"""
        # Resumen principal
        ui_components.render_suggestion_summary(suggestion)
        
        st.divider()
        
        # Productos sugeridos
        st.subheader("üõçÔ∏è Productos Sugeridos")
        ui_components.render_products_table(suggestion.products)
        
        st.divider()
        
        # Explicaci√≥n
        st.subheader("ü§ñ Explicaci√≥n de la IA")
        st.markdown(suggestion.explanation)
        
        # Gr√°ficos si est√°n habilitados
        if show_charts:
            st.divider()
            st.subheader("üìä An√°lisis Meteorol√≥gico")
            
            col1, col2 = st.columns(2)
            with col1:
                ui_components.render_weather_chart(forecast)
            with col2:
                ui_components.render_demand_factors_chart(forecast)
    
    @staticmethod
    def _display_suggestions_history():
        """Muestra el historial de sugerencias"""
        suggestions = db_service.get_all_suggestions(limit=20)
        
        if not suggestions:
            ui_components.render_info_message("No hay sugerencias guardadas a√∫n.")
            return
        
        st.markdown(f"**üìä Total de sugerencias:** {len(suggestions)}")
        
        for suggestion in suggestions:
            with st.expander(f"üè™ {suggestion['store_name']} - {suggestion['week_start']} - {suggestion['strategy'].title()}"):
                
                col1, col2, col3 = st.columns(3)
                with col1:
                    st.metric("üí∞ Inversi√≥n", f"‚Ç±{suggestion['total_investment']:,.0f}")
                with col2:
                    st.metric("üìà ROI", f"{suggestion['roi_percentage']:.1f}%")
                with col3:
                    st.metric("‚ö†Ô∏è Riesgo", suggestion['risk_level'].title())
                
                st.markdown("**ü§ñ Explicaci√≥n:**")
                st.write(suggestion['explanation'])
                
                st.markdown("**üìÖ Generada:** " + suggestion['created_at'])
    
    @staticmethod
    def _display_analytics():
        """Muestra analytics generales"""
        suggestions = db_service.get_all_suggestions()
        stores = db_service.list_stores()
        
        if not suggestions:
            ui_components.render_info_message("No hay datos suficientes para analytics.")
            return
        
        col1, col2, col3, col4 = st.columns(4)
        
        with col1:
            st.metric("üè™ Tiendas Totales", len(stores))
        
        with col2:
            st.metric("üìã Sugerencias Generadas", len(suggestions))
        
        with col3:
            avg_roi = sum(s['roi_percentage'] for s in suggestions) / len(suggestions)
            st.metric("üìä ROI Promedio", f"{avg_roi:.1f}%")
        
        with col4:
            total_investment = sum(s['total_investment'] for s in suggestions)
            st.metric("üí∞ Inversi√≥n Total", f"‚Ç±{total_investment:,.0f}")
    
    @staticmethod
    def _display_trends():
        """Muestra tendencias y an√°lisis avanzados"""
        ui_components.render_info_message("üöß An√°lisis de tendencias pr√≥ximamente disponible")


# Instancia global de p√°ginas
pages = Pages()
